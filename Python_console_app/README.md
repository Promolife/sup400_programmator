# SUP Console flash programmator

## _Описание консольных программ и протокола обмена с программатором_

# Протокол обмена
Протокол обмена с программатором простой и состоит всего из нескольких команд. Любая команда начинается с символа `$`, иначе пришлет ответ `$ERR\r\n`. Если команда не будет найдена, вернется ответ `$NODATA`
В ответ программатор присылает краткие ответы или данные, запрашиваемые пользователем.
Список команд:
| Команда | Описание |
| ------ | ------ |
| $AUT | Are you there? Опрос программатора на его присутствие. В ответ должен прислать `$OK\r\n` |
| $MRT | Memory Type. В случае присутствия flash пришлет в ответ `<7 байт>\r\n`  индетификатора flash |
| $ERS | Erase. Очистка flash. Довольно продолжительный процесс! При начале выполнения пришлет `$WAIT\r\n`  По окончанию пришлет `$OK\r\n` В случае ошибки пришлет `$ERR\r\n` |
| $WRB | Write block. Запишет информацию по указанному блоку. Формат и возможные ответы описаны ниже|
| $RDR | Read Range. Пришлет поток данных, прочитанных в диапазоне указанных адресов.  Формат и возможные ответы описаны ниже |
| $RDA | Read Address. Пришлет 16-битное содержимое ячейки flash по указанному адресу. Младший байт первым.|
| $RST | Reset. Программный сброс flash памяти. В ответ должен прислать `$OK\r\n`|

Описания формата отправки данных командой `$WRB`
По умолчанию размер блока данных 2048 байт, так же в запросе присутствует дополнительные служебные 16 байт данных. Размер блока данных указывается в исходном коде прошивки в файле `system.c` в определении `#define RX0_Buffer_Size 2048 + 16`, где 2048 - это максимальный размер данных, присланных за раз; 16 - размер служебной интформации. В случае, если информации меньше указанного размера блока, блок должен быть дополнен байтами `0xFF` до указанных размеров.

Формат данных:
```sh
$WRB<2 байта размер блока><4 байта начального адреса записи блока><Данные блока><2 байта CRC16 данных>
```
Служебные байты пишутся по старшенству: от старшего к младшим.
После приема программатор может прислать один из 3 ответов:
| Ответ | Описание |
| ------ | ------ |
| $OK\r\n | Все в порядке. Запись прошла успешно |
| $ERRCRC\r\n | Ошибка CRC. Полученные данные некорректны.|
| $WRTCRCERR\r\n | Ошибка CRC при чтении блока из flash.|

Если произошел сбой записи, flash необходимо стереть, в противном случае запись будет невозможна и будут постоянно ошибки контрольных сумм в  записи данных.

Описания формата отправки данных командой `$RDR`
Диапазон возможных адресов чтения указывается в исходном коде прошивки в файле `k5l.c` в определениях `#define Flash_address_begin 0x000000` и
`#define Flash_address_end   0x7FFFFF`. На каждую единицу адреса приходиться 2 байта из flash. Первым будет приходить младший байт.

Формат данных:
```sh
$RDR<4 байта адреса начального блока чтения><4 байта адреса конечного блока чтения>
```
Похожий запрос на чтение одной ячейки:
```sh
$RDA<4 байта адреса блока чтения>
```
Служебные байты пишутся по старшенству: от старшего к младшим.
В ответ прийдёт последовательность запрашиваемых данных. `Важно!` Контрольные суммы отсутствуют.

# Описание утилиты Write
Утилита предназначена для передачи в программатор файла на запись. Файл будет передан и записан в бинарном виде, байт за байтом.

Для запуска заходим в директорию проекта:
```sh
cd sup_console_programmator
```
Активируем ранее установленное виртуальное окружение:
```sh
source venv/Scripts/activate
```
Заходим в директорию утилит:
```sh
cd Python_console_app
```
Запускаем программу:
```sh
python write.py
```
Все! Следите за сообщениями в консоли.

# Настройка утилиты Write

Имя файла указывается в константе `WRITEFILE = 'write.bin'`, где `write.bin` - имя файла для записи, лежащий в одной директории с файлом `write.py`

Номер COM-порта, который принадлежит Arduino Mega 2560, указывается в константе `COMPORT = 'COM3'`, где COM3 - порт Arduino

`SendBlockLength = 2048` - здесь указывается размер блока данных, передаваемых в программатор. Не должен превышать указанное значение в файле `system.c` исходного кода прошивки программатора, в определении `#define RX0_Buffer_Size 2048 + 16`, где 2048 - это максимальный размер данных, присланных за раз; 16 - размер служебной интформации.

`Com_Baudrate = 1000000` - скорость COM-порта, указанная в бод. Должно совпадать со скоростью, указанной в файле `usart.c` исходного кода прошивки программатора, в определении `#define BAUD_0 1000000`. Указанно значение максимальное. В случае сбоев передачи данных рекомендуется понижать значения, вплоть до установления надежной передачи данных.